<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title> 폐·휴업 주유소 클러스터 지도</title>
    <link rel="stylesheet" href="main.css">
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Kakao (clusterer 포함) -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=&libraries=clusterer"></script>
</head>

<body>
    <header class="navbar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="폐주유소 검색" autocomplete="off" />
            <button id="search-button">
                <span><img src="pngegg.png" alt="search" width="20" height="20"></span>
            </button>
            <ul id="suggestions"></ul>
        </div>
    </header>

    <div id="map"></div>

    <script>
        kakao.maps.load(function () {
            let defaultCenter = new kakao.maps.LatLng(36.5, 127.8);
            let defaultLevel = 12;

            const savedCenter = localStorage.getItem('map_center');
            const savedLevel = localStorage.getItem('map_level');

            if (savedCenter) {
                const { lat, lng } = JSON.parse(savedCenter);
                defaultCenter = new kakao.maps.LatLng(lat, lng);
            }
            if (savedLevel) {
                defaultLevel = parseInt(savedLevel);
            }
            const map = new kakao.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                level: defaultLevel
            });
            kakao.maps.event.addListener(map, 'center_changed', function () {
                const center = map.getCenter();
                const level = map.getLevel();
                localStorage.setItem('map_center', JSON.stringify({ lat: center.getLat(), lng: center.getLng() }));
                localStorage.setItem('map_level', level);
            });



            const clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 7,
                disableClickZoom: false
            });

            const CSV_FILE = "폐주유소좌표변환.csv";
            let stations = [];
            const markers = [];
            let openInfoWindow = null;
            Papa.parse(CSV_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    if (results.errors && results.errors.length) {
                        console.warn(results.errors);
                    }

                    const data = results.data;

                    if (!data || data.length === 0) {
                        return;
                    }

                    // 헤더 출력(디버그)
                    const headers = results.meta.fields || Object.keys(data[0]);

                    // 컬럼 자동 감지 (이전 함수과 동일)
                    function findColumnName(headers, candidates) {
                        for (const c of candidates) {
                            const idx = headers.findIndex(h => h && h.toString().trim().toLowerCase() === c.toLowerCase());
                            if (idx !== -1) return headers[idx];
                        }
                        for (const h of headers) {
                            if (!h) continue;
                            const s = h.toString().toLowerCase();
                            for (const c of candidates) {
                                if (s.includes(c.toLowerCase())) return h;
                            }
                        }
                        return null;
                    }

                    const statusCol = findColumnName(headers, ["field4"]);
                    const nameCol = findColumnName(headers, ["field5"]);
                    const addrCol = findColumnName(headers, ["field6"]);
                    const latCol = findColumnName(headers, ["_Y"]);
                    const lngCol = findColumnName(headers, ["_X"]);

                    if (!latCol || !lngCol) {
                        console.log('위도/경도 컬럼을 찾을 수 없습니다. CSV 헤더 이름을 확인하세요.');
                        return;
                    }

                    let uidCounter = 0;
                    data.forEach((row, idx) => {
                        const status = statusCol ? (row[statusCol] || "").toString() : "";
                        if (!/휴업|폐업/i.test(status)) return;

                        const lat = parseFloat(row[latCol]);
                        const lng = parseFloat(row[lngCol]);

                        if (isNaN(lat) || isNaN(lng)) {
                            return;
                        }

                        const name = nameCol ? row[nameCol] : "";
                        const addr = addrCol ? row[addrCol] : "";
                        stations.push({ name, addr, lat, lng });

                        const marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(lat, lng)
                        });
                        const uid = 'iw-' + (uidCounter++);
                        const color = /폐업/.test(status) ? "#ff5a5f" : "#ffb74d";
                        const infoContent = `<div class="info-window" id="iw-${idx}">
                            <div class="info-img">(사진)</div>
                            <div class="info-body">
                                <div class="info-name">${name || '(이름없음)'}</div>
                                <div class="info-addr"> 주소: ${addr || ''}</div>
                                <div class="info-status">상태:
                                    <span class="status-badge" style="background:${color};"> ${status}</span>
                                </div>
                                <div class="info-desc">특징: </div>
                            </div>
                        </div>`;
                        const info = new kakao.maps.InfoWindow({ content: infoContent });

                        kakao.maps.event.addListener(marker, 'click', function () {
                            if (openInfoWindow) openInfoWindow.close();
                            info.open(map, marker);
                            openInfoWindow = info;
                            setTimeout(() => {
                                const iw = document.getElementById(`iw-${idx}`);
                                if (iw) {
                                    iw.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        localStorage.setItem("selectedStation", JSON.stringify({
                                            name,
                                            addr,
                                            status,
                                            lat,
                                            lng
                                        }));

                                        const popup = window.open(
                                            "detail.html",
                                            '_blank',
                                            `width=${screen.availWidth},height=${screen.availHeight},left=0,top=0,scrollbars=yes,resizable=yes`
                                        );
                                        if (popup) {
                                            popup.moveTo(0, 0);
                                            popup.resizeTo(screen.availWidth, screen.availHeight);
                                        } else {
                                            alert("팝업이 차단되었습니다. 팝업 차단을 해제하고 다시 시도해주세요.");
                                        }
                                    });
                                }
                            }, 100); // 0.1초 지연으로 DOM 완성
                        });
                        markers.push(marker);
                    });
                    if (markers.length) {
                        clusterer.addMarkers(markers);
                    }
                    kakao.maps.event.addListener(map, 'click', function () {
                        if (openInfoWindow) {
                            openInfoWindow.close();
                            openInfoWindow = null;
                        }
                    });


                    const searchInput = document.getElementById("search-input");
                    const searchButton = document.getElementById("search-button");
                    const suggestions = document.getElementById("suggestions");

                    function moveTo(station) {
                        const pos = new kakao.maps.LatLng(station.lat, station.lng);
                        map.setLevel(4);
                        map.panTo(pos);
                    }

                    searchInput.addEventListener("input", () => {
                        const keyword = searchInput.value.trim().toLowerCase();
                        suggestions.innerHTML = "";
                        if (!keyword) return;

                        stations
                            .filter(s => s.name && s.name.toLowerCase().includes(keyword))
                            .slice(0, 10)
                            .forEach(s => {
                                const li = document.createElement("li");
                                li.textContent = s.name;
                                li.onclick = () => { moveTo(s); suggestions.innerHTML = ""; searchInput.value = s.name; };
                                suggestions.appendChild(li);
                            });
                    });

                    // 검색 버튼 클릭
                    searchButton.addEventListener("click", () => {
                        const keyword = searchInput.value.trim().toLowerCase();
                        const found = stations.find(s => s.name.toLowerCase().includes(keyword));
                        if (found) moveTo(found);
                        else alert("일치하는 주유소를 찾을 수 없습니다.");
                    });

                    // 외부 클릭 시 닫기
                    document.addEventListener("click", (e) => {
                        if (!document.querySelector(".search-container").contains(e.target)) {
                            suggestions.innerHTML = "";
                        }
                    });

                    if (markers.length) {
                        clusterer.addMarkers(markers);
                    }
                }
            });
        });
    </script>
</body>

</html>
