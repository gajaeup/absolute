<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>íÂ·íœ´ì—… ì£¼ìœ ì†Œ í´ëŸ¬ìŠ¤í„° ì§€ë„</title>
    <link rel="stylesheet" href="./public/main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>

  <body>
    <header class="main-header">
      <div class="logo-container">
        <a href="main.html" id="app-logo"
          ><img src="./public/logo.jpg" alt="ë¡œê³ " class="logo-image"
        /></a>
      </div>
      <nav class="info-nav">
        <ul>
          <li>
            <a href="background.html" data-info="background">êµ¬í˜„ ë°°ê²½</a>
          </li>
          <li><a href="casestudy.html" data-info="cases">ì‹¤ì œ ì‚¬ë¡€</a></li>
          <li><a href="faq1.html" data-info="faq">FAQ</a></li>
          <li><a href="datasource.html" data-info="data">ë°ì´í„° ì¶œì²˜</a></li>
        </ul>
      </nav>
    </header>

    <aside id="left-sidebar" class="main-vertical-nav">
      <div class="nav-logo">íì£¼ìœ ì†Œ ì§€ë„</div>

      <nav>
        <ul id="nav-menu-list">
          <li id="nav-search-btn" data-target="search">
            <span class="icon">ğŸ”</span> <span>ê²€ìƒ‰</span>
          </li>
          <li id="nav-list-btn" data-target="list">
            <span class="icon">ğŸ“‹</span> <span>ëª©ë¡</span>
          </li>
          <li id="nav-guide-btn" data-target="guide">
            <span class="icon">â“</span> <span>ì´ìš© ê°€ì´ë“œ</span>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- ëª©ë¡ íŒ¨ë„ -->
    <div id="list-panel" class="side-panel" aria-hidden="true">
      <div class="side-panel__header">
        <strong>ëª©ë¡</strong>
        <button type="button" id="list-panel-close" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="side-panel__body">
        <!-- ì—¬ê¸°ì— ëª©ë¡ ì½˜í…ì¸  ë Œë”ë§ -->
        ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤â€¦
      </div>
    </div>

    <!-- ì´ìš© ê°€ì´ë“œ íŒ¨ë„ -->
    <div id="guide-panel" class="side-panel" aria-hidden="true">
      <div class="side-panel__header">
        <strong>ì´ìš© ê°€ì´ë“œ</strong>
        <button type="button" id="guide-panel-close" aria-label="ë‹«ê¸°">
          Ã—
        </button>
      </div>
      <div class="side-panel__body guide-body">
        <!-- ì¹´ë“œ: ê²€ìƒ‰í•˜ê¸° -->
        <section class="guide-card is-blue">
          <div class="guide-card__thumb">
            <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </div>
          <div class="guide-card__content">
            <h3>ê²€ìƒ‰í•˜ê¸°</h3>
            <p>ì£¼ìœ ì†Œì˜ ì´ë¦„ì´ë‚˜ ì§€ì—­ì„ ê²€ìƒ‰í•´ íì£¼ìœ ì†Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</p>
          </div>
        </section>

        <!-- ì¹´ë“œ: í•´ê²°ë°©ì•ˆ ë³´ê¸° -->
        <section class="guide-card is-pink">
          <div class="guide-card__thumb">
            <!-- ì£¼ìœ  ì•„ì´ì½˜ -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M3 21V7a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v14H3z"
                fill="currentColor"
                opacity=".15"
              />
              <path
                d="M3 21V7a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v14M6 10h7M6 14h7M19 9l2 2v7a3 3 0 0 1-3 3h-2"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
          <div class="guide-card__content">
            <h3>í•´ê²°ë°©ì•ˆ ë³´ê¸°</h3>
            <p>
              íì£¼ìœ ì†Œë¥¼ í´ë¦­í•´ í•´ë‹¹ ì¥ì†Œì˜ <strong>ì¶”ì²œ í™œìš©ë°©ì•ˆ</strong>ì„
              í™•ì¸í•˜ì„¸ìš”.
            </p>
          </div>
        </section>

        <!-- ì¹´ë“œ: ë³´ê³ ì„œ ë‹¤ìš´ë°›ê¸° -->
        <section class="guide-card is-green">
          <div class="guide-card__thumb">
            <!-- ë¦¬í¬íŠ¸ ì•„ì´ì½˜ -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M6 3h8l4 4v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
                fill="currentColor"
                opacity=".15"
              />
              <path
                d="M14 3v5h5M8 12h8M8 16h5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
          <div class="guide-card__content">
            <h3>ë³´ê³ ì„œ ë‹¤ìš´ë°›ê¸°</h3>
            <p>
              ì¶”ì²œì˜ ê·¼ê±°ê°€ ë˜ëŠ” ì§€í‘œê°€ ë‹´ê¸´ <strong>ë³´ê³ ì„œ</strong>ë¥¼
              ë‚´ë ¤ë°›ì•„ë³´ì„¸ìš”.
            </p>
          </div>
        </section>
      </div>
    </div>

    <div class="search-container">
      <div id="search-tabs" class="search-tabs">
        <button id="tab-station" class="active">ì£¼ìœ ì†Œ ê²€ìƒ‰</button>
        <button id="tab-region">ì§€ì—­ ê²€ìƒ‰</button>
      </div>
      <div id="search-content-container">
        <div id="station-search-module" class="search-module active">
          <input
            type="text"
            id="search-input"
            placeholder="ì£¼ìœ ì†Œ ì´ë¦„ ê²€ìƒ‰"
          /><button
            id="search-button"
            img
            src="/public/pngegg.png"
            alt="ê²€ìƒ‰"
            width="20"
            height="20"
          ></button>
          <ul id="suggestions"></ul>
        </div>

        <div id="region-search-module" class="search-module hidden">
          <div id="region-dropdowns" class="dropdown-group">
            <select id="select-sido" class="region-select"></select>
            <select id="select-sigungu" class="region-select" disabled></select>
            <select
              id="select-eupmyeondong"
              class="region-select"
              disabled
            ></select>
          </div>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <script>
      async function loadKakao() {
        let apiKey;
        const isLocal =
          location.hostname === 'localhost' ||
          location.hostname === '127.0.0.1';
        if (isLocal) {
          apiKey = '';
          console.log(' Local Kakao Key ì‚¬ìš©ì¤‘');
        } else {
          try {
            const res = await fetch('/api/kakao');
            const data = await res.json();
            apiKey = data.key;
            console.log(' Vercel Key ì‚¬ìš©ì¤‘');
          } catch (err) {
            console.error('ì„œë²„ì—ì„œ í‚¤ ë°›ê¸° ì‹¤íŒ¨', err);
            return;
          }
        }
        const script = document.createElement('script');
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?autoload=false&appkey=${apiKey}&libraries=services,clusterer`;
        script.onload = () => {
          console.log('âœ… SDK script loaded:', !!window.kakao);
          kakao.maps.load(() => {
            console.log('âœ… kakao.maps.load callback fired');
            initMap();
          });
        };

        document.head.appendChild(script);
      }

      loadKakao();
      let openOverlay = null;
      let closeTimer = null;
      function showDetailPanel(station) {
        document.getElementById('sidebar-name').textContent = station.name;
        document.getElementById('sidebar-addr').textContent = station.addr;
        document.getElementById('sidebar-status').textContent = station.status;

        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('hidden');

        const pos = new kakao.maps.LatLng(station.lat, station.lng);
        const container = document.getElementById('roadview');
        container.innerHTML = '';
        const rv = new kakao.maps.Roadview(container);
        const rvc = new kakao.maps.RoadviewClient();

        rvc.getNearestPanoId(pos, 50, (panoId) => {
          if (panoId) rv.setPanoId(panoId, pos);
          else
            container.innerHTML =
              "<p style='padding:25px;text-align:center'>ë¡œë“œë·° ì—†ìŒ</p>";
        });
      }
      async function initMap() {
        let defaultCenter = new kakao.maps.LatLng(36.5, 127.8);
        let defaultLevel = 12;

        const savedCenter = localStorage.getItem('map_center');
        const savedLevel = localStorage.getItem('map_level');

        if (savedCenter) {
          const { lat, lng } = JSON.parse(savedCenter);
          defaultCenter = new kakao.maps.LatLng(lat, lng);
        }
        if (savedLevel) defaultLevel = parseInt(savedLevel);

        const map = new kakao.maps.Map(document.getElementById('map'), {
          center: defaultCenter,
          level: defaultLevel,
        });

        kakao.maps.event.addListener(map, 'center_changed', () => {
          const center = map.getCenter();
          const level = map.getLevel();
          localStorage.setItem(
            'map_center',
            JSON.stringify({ lat: center.getLat(), lng: center.getLng() })
          );
          localStorage.setItem('map_level', level);
        });

        const clusterer = new kakao.maps.MarkerClusterer({
          map,
          averageCenter: true,
          minLevel: 7,
          disableClickZoom: false,
        });

        const CSV_FILE = '/public/station.csv';
        const stations = [];
        const markers = [];
        let polygons = [];

        const geoSources = {
          sido: '/public/ctprvn_wgs84.json',
          sig: '/public/sig_wgs84_simplified.json',
          emd: '/public/HangJeongDong_ver20250401_simplified.json',
        };
        const geoData = {};

        for (const [key, path] of Object.entries(geoSources)) {
          try {
            const res = await fetch(path);
            geoData[key] = await res.json();
            console.log(
              `âœ… ${key} ë ˆì´ì–´ ë¡œë“œ ì™„ë£Œ:`,
              geoData[key].features.length
            );
          } catch (err) {
            console.error(`${key} GeoJSON ë¡œë“œ ì‹¤íŒ¨`, err);
          }
        }

        Papa.parse(CSV_FILE, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const data = results.data;
            const headers = results.meta.fields || Object.keys(data[0]);

            function findColumnName(headers, candidates) {
              for (const c of candidates) {
                const idx = headers.findIndex(
                  (h) => h && h.toLowerCase() === c.toLowerCase()
                );
                if (idx !== -1) return headers[idx];
              }
              for (const h of headers) {
                if (!h) continue;
                const s = h.toLowerCase();
                for (const c of candidates)
                  if (s.includes(c.toLowerCase())) return h;
              }
              return null;
            }

            const statusCol = findColumnName(headers, ['field4']);
            const nameCol = findColumnName(headers, ['field5']);
            const addrCol = findColumnName(headers, ['field6']);
            const latCol = findColumnName(headers, ['_Y']);
            const lngCol = findColumnName(headers, ['_X']);

            const tabStation = document.getElementById('tab-station');
            const tabRegion = document.getElementById('tab-region');
            const stationModule = document.getElementById(
              'station-search-module'
            );
            const regionModule = document.getElementById(
              'region-search-module'
            );

            // ë“œë¡­ë‹¤ìš´ ìš”ì†Œ
            const selectSido = document.getElementById('select-sido');
            const selectSigungu = document.getElementById('select-sigungu');
            const selectEupmyeondong = document.getElementById(
              'select-eupmyeondong'
            );

            const seen = new Set();
            data.reverse().forEach((row, idx) => {
              const status = row[statusCol] || '';
              if (!/íœ´ì—…|íì—…/.test(status)) return;

              const lat = parseFloat(row[latCol]);
              const lng = parseFloat(row[lngCol]);
              if (isNaN(lat) || isNaN(lng)) return;

              const key = `${lat},${lng}`;
              if (seen.has(key)) return;
              seen.add(key);

              const name = row[nameCol] || '';
              const addr = row[addrCol] || '';
              stations.push({ name, addr, lat, lng });

              const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lng),
              });

              const color = /íì—…/.test(status) ? '#ff5a5f' : '#ffb74d';
              const infoHTML = `
          <div class="info-window" id="iw-${idx}">
            <div class="info-img"><img src="station_images/ëŒ€ë¦¼ì£¼ìœ ì†Œ.jpg" width="234" height="110"></div>
            <div class="info-body">
              <div class="info-name">${name || '(ì´ë¦„ì—†ìŒ)'}</div>
              <div class="info-addr">ì£¼ì†Œ: ${addr}</div>
              <div class="info-status">ìƒíƒœ: <span class="status-badge" style="background:${color};">${status}</span></div>
            </div>
          </div>
        `;
              const overlay = new kakao.maps.CustomOverlay({
                position: marker.getPosition(),
                content: infoHTML,
                yAnchor: 1.5,
              });

              kakao.maps.event.addListener(marker, 'mouseover', () => {
                if (closeTimer) {
                  clearTimeout(closeTimer);
                  closeTimer = null;
                }
                if (openOverlay) openOverlay.setMap(null);
                overlay.setMap(map);
                openOverlay = overlay;

                setTimeout(() => {
                  const iw = document.getElementById(`iw-${idx}`);
                  if (!iw) return;

                  iw.addEventListener('mouseenter', () => {
                    if (closeTimer) clearTimeout(closeTimer);
                  });
                  iw.addEventListener('mouseleave', () => {
                    closeTimer = setTimeout(() => {
                      if (openOverlay) openOverlay.setMap(null);
                      openOverlay = null;
                    }, 200);
                  });

                  iw.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDetailPanel({ name, addr, status, lat, lng });
                    if (openOverlay) {
                      openOverlay.setMap(null);
                      openOverlay = null;
                    }
                  });
                }, 80);
              });
              kakao.maps.event.addListener(marker, 'mouseout', () => {
                closeTimer = setTimeout(() => {
                  const hoveredCard =
                    document.querySelector('.info-window:hover');
                  if (!hoveredCard && openOverlay) {
                    openOverlay.setMap(null);
                    openOverlay = null;
                  }
                }, 200);
              });

              markers.push(marker);
            });
            clusterer.addMarkers(markers);
            connectSearchEvents(stations, map);

            function switchSearchMode(mode) {
              if (mode === 'station') {
                tabStation.classList.add('active');
                tabRegion.classList.remove('active');
                stationModule.classList.remove('hidden');
                regionModule.classList.add('hidden');
              } else if (mode === 'region') {
                tabRegion.classList.add('active');
                tabStation.classList.remove('active');
                regionModule.classList.remove('hidden');
                stationModule.classList.add('hidden');
                loadSidoData();
              }
            }

            // GeoJSON ë°ì´í„° ë¡œë“œ ë° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            function loadSidoData() {
              const sidoData = geoData.sido.features;
              selectSido.innerHTML =
                '<option value="">-- ì‹œ/ë„ ì„ íƒ --</option>';
              selectSigungu.innerHTML =
                '<option value="">-- ì‹œ/êµ°/êµ¬ ì„ íƒ --</option>';
              selectEupmyeondong.innerHTML =
                '<option value="">-- ì/ë©´/ë™ ì„ íƒ --</option>';
              selectSigungu.disabled = true;
              selectEupmyeondong.disabled = true;

              sidoData.forEach((f) => {
                const name = f.properties['CTP_KOR_NM'];
                const option = new Option(name, name);
                selectSido.add(option);
              });
            }

            function loadSigunguData(selectedSido) {
              const sigunguData = geoData.sig.features;
              selectSigungu.innerHTML =
                '<option value="">-- ì‹œ/êµ°/êµ¬ ì„ íƒ --</option>';
              selectEupmyeondong.innerHTML =
                '<option value="">-- ì/ë©´/ë™ ì„ íƒ --</option>';
              selectEupmyeondong.disabled = true;

              const sidoCodeMap = {
                ì„œìš¸íŠ¹ë³„ì‹œ: '11',
                ë¶€ì‚°ê´‘ì—­ì‹œ: '26',
                ëŒ€êµ¬ê´‘ì—­ì‹œ: '27',
                ì¸ì²œê´‘ì—­ì‹œ: '28',
                ê´‘ì£¼ê´‘ì—­ì‹œ: '29',
                ëŒ€ì „ê´‘ì—­ì‹œ: '30',
                ìš¸ì‚°ê´‘ì—­ì‹œ: '31',
                ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ: '36',
                ê²½ê¸°ë„: '41',
                ê°•ì›íŠ¹ë³„ìì¹˜ë„: '51',
                ì¶©ì²­ë¶ë„: '43',
                ì¶©ì²­ë‚¨ë„: '44',
                ì „ë¶íŠ¹ë³„ìì¹˜ë„: '52',
                ì „ë¼ë‚¨ë„: '46',
                ê²½ìƒë¶ë„: '47',
                ê²½ìƒë‚¨ë„: '48',
                ì œì£¼íŠ¹ë³„ìì¹˜ë„: '50',
              };
              const sidoPrefix = sidoCodeMap[selectedSido];
              if (!sidoPrefix) {
                console.warn('âš ï¸ ì‹œë„ ì½”ë“œ ë§¤ì¹­ ì‹¤íŒ¨:', selectedSido);
                return;
              }
              const filteredSigungu = sigunguData.filter((f) => {
                const sigCd = String(f.properties['SIG_CD'] || '').trim();
                return sigCd.substring(0, 2) === sidoPrefix;
              });

              filteredSigungu.forEach((f) => {
                const name = f.properties['SIG_KOR_NM'];
                const option = new Option(name, name);
                selectSigungu.add(option);
              });

              if (selectSigungu.options.length > 1) {
                selectSigungu.disabled = false;
              }
            }

            function loadEupmyeondongData(selectedSigungu) {
              const emdData = geoData.emd.features;
              selectEupmyeondong.innerHTML =
                '<option value="">-- ì/ë©´/ë™ ì„ íƒ --</option>';
              const selectedSido = selectSido.value; // âœ… ì¶”ê°€
              if (!selectedSido || !selectedSigungu) return;

              const sigFeature = geoData.sig.features.find(
                (f) => f.properties['SIG_KOR_NM'] === selectedSigungu
              );
              const filteredEmd = emdData.filter((f) => {
                const full = f.properties['adm_nm'] || '';
                return full.startsWith(`${selectedSido} ${selectedSigungu}`);
              });

              filteredEmd.forEach((f) => {
                const fullName = f.properties['adm_nm'] || '';
                const emdName = fullName.split(' ').pop();
                const option = new Option(emdName, fullName); // âœ… valueëŠ” ì „ì²´ í–‰ì •ëª…
                selectEupmyeondong.add(option);
              });

              if (selectEupmyeondong.options.length > 1) {
                selectEupmyeondong.disabled = false;
              }
            }

            // ê²€ìƒ‰ ì´ë²¤íŠ¸ ì—°ê²° ë° ë“œë¡­ë‹¤ìš´ ì²´ì¸
            function connectSearchEvents(stations, map) {
              tabStation.addEventListener('click', () =>
                switchSearchMode('station')
              );
              tabRegion.addEventListener('click', () =>
                switchSearchMode('region')
              );

              selectSido.addEventListener('change', () => {
                const selectedSido = selectSido.value;
                loadSigunguData(selectedSido);
                drawRegion(selectedSido, map);
              });

              selectSigungu.addEventListener('change', () => {
                const selectedSigungu = selectSigungu.value;
                loadEupmyeondongData(selectedSigungu);
                drawRegion(selectedSigungu, map);
              });

              selectEupmyeondong.addEventListener('change', () => {
                const selectedEmd = selectEupmyeondong.value;
                drawRegion(selectedEmd, map);
              });

              const searchButton = document.getElementById('search-button');
              const searchInput = document.getElementById('search-input');
              // í…ìŠ¤íŠ¸ ê²€ìƒ‰ ë²„íŠ¼ ì—°ê²°
              searchButton.onclick = () => {
                if (tabStation.classList.contains('active')) {
                  handleStationSearch(stations, map);
                }
              };

              searchInput.addEventListener('keypress', (e) => {
                if (
                  e.key === 'Enter' &&
                  tabStation.classList.contains('active')
                ) {
                  handleStationSearch(stations, map);
                }
              });
            }

            // ìµœì¢… ê²€ìƒ‰ ì‹¤í–‰ (í…ìŠ¤íŠ¸ ê²€ìƒ‰)
            function handleStationSearch(stations, map) {
              const searchInput = document.getElementById('search-input');
              const keyword = searchInput.value.trim();
              const list = document.getElementById('suggestions');
              list.innerHTML = '';
              if (!keyword) return;

              const foundStation = stations.filter(
                (s) =>
                  s.name &&
                  s.name.toLowerCase().startsWith(keyword.toLowerCase())
              );
              if (foundStation.length === 1) {
                const pos = new kakao.maps.LatLng(
                  foundStation.lat,
                  foundStation.lng
                );
                map.setLevel(4);
                map.panTo(pos);
                return;
              }
              if (foundStation.length === 0) {
                alert('ì¼ì¹˜í•˜ëŠ” ì£¼ìœ ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }
              foundStation.forEach((s, idx) => {
                const li = document.createElement('li');
                li.textContent = `${s.name} (${s.addr})`;
                li.classList.add('suggestion-item');
                li.style.cursor = 'pointer';

                // í´ë¦­ ì‹œ ì§€ë„ ì´ë™
                li.addEventListener('click', () => {
                  const pos = new kakao.maps.LatLng(s.lat, s.lng);
                  map.setLevel(4);
                  map.panTo(pos);

                  // ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
                  list.innerHTML = '';
                  document.getElementById('search-input').value = s.name;
                });

                list.appendChild(li);
              });
            }

            // í–‰ì •êµ¬ì—­ ê²€ìƒ‰ ì‹¤í–‰ (í…ìŠ¤íŠ¸ -> GeoJSON)
            function handleRegionSearch(keyword, map) {
              const layers = [
                { name: 'ì‹œë„', data: geoData.sido, key: 'CTP_KOR_NM' },
                { name: 'ì‹œêµ°êµ¬', data: geoData.sig, key: 'SIG_KOR_NM' },
                { name: 'ìë©´ë™', data: geoData.emd, key: 'adm_nm' },
              ];
              for (const { name, data, key } of layers) {
                if (!data) continue;
                const match = data.features.find(
                  (f) =>
                    f.properties[key] && f.properties[key].startsWith(keyword)
                );
                if (match) {
                  console.log(`âœ… ${name} ë§¤ì¹­ë¨:`, match.properties[key]);
                  try {
                    drawPolygon(match, map);
                  } catch (e) {
                    console.error(
                      'âŒ drawPolygon í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ:',
                      e
                    );
                  }
                  return true;
                }
              }
              return false;
            }

            function drawRegion(name) {
              const sidoCodeMap = {
                ì„œìš¸íŠ¹ë³„ì‹œ: '11',
                ë¶€ì‚°ê´‘ì—­ì‹œ: '26',
                ëŒ€êµ¬ê´‘ì—­ì‹œ: '27',
                ì¸ì²œê´‘ì—­ì‹œ: '28',
                ê´‘ì£¼ê´‘ì—­ì‹œ: '29',
                ëŒ€ì „ê´‘ì—­ì‹œ: '30',
                ìš¸ì‚°ê´‘ì—­ì‹œ: '31',
                ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ: '36',
                ê²½ê¸°ë„: '41',
                ê°•ì›íŠ¹ë³„ìì¹˜ë„: '51',
                ì¶©ì²­ë¶ë„: '43',
                ì¶©ì²­ë‚¨ë„: '44',
                ì „ë¶íŠ¹ë³„ìì¹˜ë„: '52',
                ì „ë¼ë‚¨ë„: '46',
                ê²½ìƒë¶ë„: '47',
                ê²½ìƒë‚¨ë„: '48',
                ì œì£¼íŠ¹ë³„ìì¹˜ë„: '50',
              };
              const selectedSido =
                document.getElementById('select-sido')?.value || '';
              const selectedSigungu =
                document.getElementById('select-sigungu')?.value || '';
              const selectedEmd =
                document.getElementById('select-eupmyeondong')?.value || '';
              const sidoPrefix = sidoCodeMap[selectedSido];

              let match = null;

              // 1ï¸âƒ£ ì‹œë„
              match = geoData.sido.features.find(
                (f) => f.properties['CTP_KOR_NM'] === name
              );

              if (selectedEmd) {
                match = geoData.emd.features.find((f) => {
                  const full = f.properties['adm_nm']?.trim() || '';
                  return (
                    full === selectedEmd.trim() ||
                    full.endsWith(selectedEmd.trim())
                  );
                });
              }

              // 2ï¸âƒ£ ìë©´ë™ ë§¤ì¹­ì´ ì—†ì„ ë•Œë§Œ ì‹œêµ°êµ¬ë¡œ fallback
              if (!match && selectedSigungu) {
                match = geoData.sig.features.find(
                  (f) =>
                    f.properties['SIG_KOR_NM'] === selectedSigungu &&
                    f.properties['SIG_CD'].startsWith(sidoPrefix)
                );
              }

              if (match) {
                drawPolygon(match);
                return;
              }
            }

            function drawPolygon(feature) {
              polygons.forEach((p) => p.setMap(null));
              polygons = [];

              if (!feature || !feature.geometry || !feature.geometry.type)
                return;

              const polygonPaths = [];

              if (feature.geometry.type === 'Polygon') {
                const coords = feature.geometry.coordinates[0];
                const path = coords.map(
                  ([x, y]) => new kakao.maps.LatLng(y, x)
                );
                polygonPaths.push(path);
              } else if (feature.geometry.type === 'MultiPolygon') {
                feature.geometry.coordinates.forEach((polygonBoundarySet) => {
                  const outerBoundaryCoords = polygonBoundarySet[0];
                  if (outerBoundaryCoords && outerBoundaryCoords.length > 0) {
                    const path = outerBoundaryCoords
                      .map(([x, y]) => {
                        const lat = parseFloat(y);
                        const lng = parseFloat(x);
                        if (isNaN(lat) || isNaN(lng)) return null;
                        return new kakao.maps.LatLng(lat, lng);
                      })
                      .filter((p) => p !== null);
                    if (path.length > 0) polygonPaths.push(path);
                  }
                });
              } else {
                console.warn(
                  'ì§€ì›í•˜ì§€ ì•ŠëŠ” geometry íƒ€ì…:',
                  feature.geometry.type
                );
                return;
              }

              // âœ… forEach ë°–ìœ¼ë¡œ ì´ë™ (Polygonê³¼ MultiPolygon ëª¨ë‘ ê³µí†µ)
              if (polygonPaths.length > 0) {
                const polygon = new kakao.maps.Polygon({
                  path: polygonPaths,
                  strokeWeight: 2,
                  strokeColor: '#00695c',
                  strokeOpacity: 0.8,
                  fillColor: 'rgba(0,150,136,0.35)',
                  fillOpacity: 0.6,
                });

                polygon.setMap(map);
                polygons.push(polygon);

                const bounds = new kakao.maps.LatLngBounds();
                polygonPaths.flat().forEach((p) => bounds.extend(p));
                map.setBounds(bounds);
                map.relayout();
              }

              // --- 3. ê·¸ ì™¸ íƒ€ì… ì²˜ë¦¬ ---
              else {
                console.error(
                  'ì§€ì›í•˜ì§€ ì•ŠëŠ” GeoJSON geometry íƒ€ì…:',
                  feature.geometry.type
                );
                return;
              }

              // â­â­â­ ì´í•˜ëŠ” GeoJSON ì²˜ë¦¬ ë¡œì§ì´ ëª¨ë‘ ëë‚œ í›„ ì‹¤í–‰ë©ë‹ˆë‹¤. â­â­â­
              if (polygonPaths.length === 0) return;

              // â­ Kakao Maps Polygonì€ MultiPolygon ì²˜ë¦¬ë¥¼ ìœ„í•´ ê²½ë¡œ ë°°ì—´ì˜ ë°°ì—´ì„ í—ˆìš©í•©ë‹ˆë‹¤.
            }
          },
        });
        document.getElementById('sidebar-close').onclick = () =>
          document.getElementById('sidebar').classList.add('hidden');
      }
    </script>

    <script>
      (function () {
        // ë²„íŠ¼ & ìš”ì†Œ
        const listBtn = document.getElementById('nav-list-btn');
        const guideBtn = document.getElementById('nav-guide-btn');
        const searchBtn = document.getElementById('nav-search-btn'); // ë‹¤ë¥¸ ì•„ì´ì½˜ ëˆ„ë¥´ë©´ ë‹«ê¸°ìš©
        const panels = {
          list: document.getElementById('list-panel'),
          guide: document.getElementById('guide-panel'),
        };
        const closeBtns = {
          list: document.getElementById('list-panel-close'),
          guide: document.getElementById('guide-panel-close'),
        };
        const searchBox = document.querySelector('.search-container');

        // ìœ í‹¸
        const isOpen = (p) => p && p.classList.contains('is-open');

        function anyOpen() {
          return Object.values(panels).some((p) => p && isOpen(p));
        }

        function pushSearch(on) {
          if (!searchBox) return;
          if (on) searchBox.classList.add('pushed-by-list');
          else searchBox.classList.remove('pushed-by-list');
        }

        function openPanel(panel) {
          if (!panel) return;
          closeAllPanels(); // âœ… ë‹¤ë¥¸ íŒ¨ë„ì€ ìë™ìœ¼ë¡œ ë‹«í˜
          panel.classList.add('is-open');
          panel.setAttribute('aria-hidden', 'false');
          pushSearch(true);
        }

        function closePanel(panel) {
          if (!panel) return;
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden', 'true');
          if (!anyOpen()) pushSearch(false); // ë‘˜ ë‹¤ ë‹«íˆë©´ ê²€ìƒ‰ì°½ ì›ìœ„ì¹˜
        }

        function closeAllPanels() {
          Object.values(panels).forEach((p) => {
            if (p && isOpen(p)) {
              p.classList.remove('is-open');
              p.setAttribute('aria-hidden', 'true');
            }
          });
          pushSearch(false);
        }

        // í† ê¸€
        function toggle(panel) {
          if (!panel) return;
          if (isOpen(panel)) closePanel(panel);
          else openPanel(panel);
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        if (listBtn)
          listBtn.addEventListener('click', () => toggle(panels.list));
        if (guideBtn)
          guideBtn.addEventListener('click', () => toggle(panels.guide));
        if (searchBtn) searchBtn.addEventListener('click', closeAllPanels); // ğŸ” ëˆ„ë¥´ë©´ ë‹«ê¸°

        if (closeBtns.list)
          closeBtns.list.addEventListener('click', () =>
            closePanel(panels.list)
          );
        if (closeBtns.guide)
          closeBtns.guide.addEventListener('click', () =>
            closePanel(panels.guide)
          );

        // ESCë¡œ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAllPanels();
        });
      })();
    </script>

    <div id="sidebar" class="sidebar hidden">
      <div class="sidebar-header">
        <span id="sidebar-name"></span>
        <button id="sidebar-close">X</button>
      </div>

      <div class="sidebar-body">
        <p><strong>ì£¼ì†Œ:</strong> <span id="sidebar-addr"></span></p>
        <p><strong>ìƒíƒœ:</strong> <span id="sidebar-status"></span></p>

        <div id="roadview" class="roadview-box"></div>
      </div>
    </div>
  </body>
</html>
