<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title> 폐·휴업 주유소 클러스터 지도</title>
    <link rel="stylesheet" href="main.css">
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Kakao (clusterer 포함) -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=&libraries=clusterer"></script>
</head>

<body>
    <header class="navbar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="폐주유소 검색" autocomplete="off" />
            <button id="search-button">
                <span><img src="pngegg.png" alt="search" width="20" height="20"></span>
            </button>
            <ul id="suggestions"></ul>
        </div>
    </header>

    <div id="map"></div>

    <script>
        kakao.maps.load(function () {

            const map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(36.5, 127.8),
                level: 12
            });



            const clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 7,
                disableClickZoom: false
            });

            const CSV_FILE = "산업통상자원부_폐휴업주유소_좌표추가_kakao.csv";
            let stations = [];
            Papa.parse(CSV_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    if (results.errors && results.errors.length) {
                        console.warn(results.errors);
                    }

                    const data = results.data;

                    if (!data || data.length === 0) {
                        return;
                    }

                    // 헤더 출력(디버그)
                    const headers = results.meta.fields || Object.keys(data[0]);
                    console.log('CSV 헤더: ' + JSON.stringify(headers));

                    // 컬럼 자동 감지 (이전 함수과 동일)
                    function findColumnName(headers, candidates) {
                        for (const c of candidates) {
                            const idx = headers.findIndex(h => h && h.toString().trim().toLowerCase() === c.toLowerCase());
                            if (idx !== -1) return headers[idx];
                        }
                        for (const h of headers) {
                            if (!h) continue;
                            const s = h.toString().toLowerCase();
                            for (const c of candidates) {
                                if (s.includes(c.toLowerCase())) return h;
                            }
                        }
                        return null;
                    }

                    const statusCol = findColumnName(headers, ["상태", "status", "상태코드", "구분"]);
                    const nameCol = findColumnName(headers, ["업체명"]);
                    const addrCol = findColumnName(headers, ["주소", "소재지", "소재지지번", "주소지"]);
                    const latCol = findColumnName(headers, ["위도", "lat", "y"]);
                    const lngCol = findColumnName(headers, ["경도", "lng", "lon", "x", "long"]);

                    if (!latCol || !lngCol) {
                        console.log('위도/경도 컬럼을 찾을 수 없습니다. CSV 헤더 이름을 확인하세요.');
                        return;
                    }



                    const markers = [];

                    let shown = 0;
                    data.forEach((row, idx) => {
                        const status = statusCol ? (row[statusCol] || "").toString() : "";
                        if (!/휴업|폐업/i.test(status)) return;

                        const lat = parseFloat(row[latCol]);
                        const lng = parseFloat(row[lngCol]);

                        if (isNaN(lat) || isNaN(lng)) {
                            return;
                        }

                        const name = nameCol ? row[nameCol] : "";
                        const addr = addrCol ? row[addrCol] : "";
                        stations.push({ name, addr, lat, lng });

                        const marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(lat, lng)
                        });
                        const color = /폐업/.test(status) ? "#ff5a5f" : "#ffb74d";
                        const infoContent = `<div style="padding:6px 8px;font-size:13px;">
                        <div style="font-weight:600">${name || '(이름없음)'}</div>
                        <div style="margin-top:4px"> 주소: ${addr || ''}</div>
                        <div style="margin-top:6px"><span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:6px;margin-right:6px;"></span>상태: ${status}</div>
                        </div>`;
                        const info = new kakao.maps.InfoWindow({ content: infoContent });
                        kakao.maps.event.addListener(marker, 'click', function () { info.open(map, marker); });

                        markers.push(marker);
                        shown++;
                    });

                    const searchInput = document.getElementById("search-input");
                    const searchButton = document.getElementById("search-button");
                    const suggestions = document.getElementById("suggestions");

                    function moveTo(station) {
                        const pos = new kakao.maps.LatLng(station.lat, station.lng);
                        map.setLevel(4);
                        map.panTo(pos);
                    }

                    searchInput.addEventListener("input", () => {
                        const keyword = searchInput.value.trim().toLowerCase();
                        suggestions.innerHTML = "";
                        if (!keyword) return;

                        stations
                            .filter(s => s.name && s.name.toLowerCase().includes(keyword))
                            .slice(0, 10)
                            .forEach(s => {
                                const li = document.createElement("li");
                                li.textContent = s.name;
                                li.onclick = () => { moveTo(s); suggestions.innerHTML = ""; searchInput.value = s.name; };
                                suggestions.appendChild(li);
                            });
                    });

                    // 검색 버튼 클릭
                    searchButton.addEventListener("click", () => {
                        const keyword = searchInput.value.trim().toLowerCase();
                        const found = stations.find(s => s.name.toLowerCase().includes(keyword));
                        if (found) moveTo(found);
                        else alert("일치하는 주유소를 찾을 수 없습니다.");
                    });

                    // 외부 클릭 시 닫기
                    document.addEventListener("click", (e) => {
                        if (!document.querySelector(".search-container").contains(e.target)) {
                            suggestions.innerHTML = "";
                        }
                    });
                    if (markers.length) {
                        clusterer.addMarkers(markers);
                    }
                }
            });
        });
    </script>
</body>

</html>